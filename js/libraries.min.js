/* ========================================================================
 * freqselector
 * http://twostairs.com
 * ========================================================================
 * Copyright 2011-2014 Marius M. <marius@twostairs.com>
 * Licensed under MIT (http://opensource.org/licenses/MIT)
 * ======================================================================== */


(function ($) {
  'use strict';

  var Freqselector = function (element, options) {
    this.options        = options;
    this.$body          = $(element).parent();
    this.$element       = $(element);
    this.$background  = $(element).find('.freqselector-background');
    this.$arrow     = $(element).find('.freqselector-arrow-top');
    this.$content     = $(element).find('.freqselector-content');

    this.arrowLeft    = 0;
    this.arrowCenterOffset = 11;
    this.isShown        = false;
    this.isSelected   = "";

    this.initializeFreqselector();
  };

  Freqselector.VERSION  = '1.0.2';

  Freqselector.DEFAULTS = {
    show: false
  };

  Freqselector.prototype.toggle = function (_relatedTarget) {
    return this.isShown ? this.hide() : this.show(_relatedTarget);
  };

  Freqselector.prototype.show = function (_relatedTarget) {
    var e    = $.Event('show.freqselector', { relatedTarget: _relatedTarget });

    this.$element.trigger(e);

    if (this.isShown || e.isDefaultPrevented()) { return; }

    this.isShown = true;

    if($.support.transition) {
    this.$element.css("display", "block");
    this.$element.animate({
      opacity: 1.0,
      height: "80px"
    }, "fast", function() {
      // Move it?
    });
    } else {
      this.showFreqselector();
    }
  };

  Freqselector.prototype.hide = function (e) {
    if (e) { e.preventDefault(); }

    e = $.Event('hide.freqselector');

    this.$element.trigger(e);

    if (!this.isShown || e.isDefaultPrevented()) {
      return;
    }
    this.isShown = false;

    this.$element
      .attr('aria-hidden', true)
      .off('click.dismiss.freqselector');

    if($.support.transition) {
      this.$element.css("display", "none");
      this.$element.animate({
      opacity: 0.0,
      height: "0px"
    }, "fast", function() {
      // Move it?
    });
    } else {
      this.hideFreqselector();
    }
  };

  Freqselector.prototype.showFreqselector = function () {
    this.isShown = true;
    this.$element.css("display", "block").css("height", "80px").css("opacity", "1");
  };

  Freqselector.prototype.hideFreqselector = function () {
    this.isShown = false;
    this.$element.css("display", "none").css("height", "0px").css("opacity", "0");
  };

  Freqselector.prototype.initializeFreqselector = function () {
    jQuery(window).resize((function(_this) {
      return function() {
        _this.resizeFreqselector();
      };
    })(this));
    jQuery(window).resize();

    this.$background.overscroll({
      showThumbs: false,
      direction: 'horizontal',
      wheelDirection: 'horizontal',
      openedCursor: '',
      closedCursor: '',
      captureWheel: false
    });
    this.initializeOverscroll();
    this.initializeItemClick();
    this.show();
  };

  Freqselector.prototype.initializeOverscroll = function () {
    this.$background.off('overscroll:dragend').on('overscroll:dragend', (function(_this) {
      return function() {
        var resultsArray = [];

        _this.$element.find('.freqselector-item-snap').each(function() {
          var itemDistance = jQuery(this).offset().left;
          var itemId = jQuery(this).attr('id').replace(/freqselector-item-/, "");
          resultsArray.push({ 'id': itemId, 'distance': itemDistance });
        });

        var closest = null;
        var prev = Math.abs(resultsArray[0].distance - _this.arrowLeft - _this.arrowCenterOffset);
        for (var i = 1; i < resultsArray.length; i++) {
            var diff = Math.abs(resultsArray[i].distance - _this.arrowLeft - _this.arrowCenterOffset);
            if (diff < prev) {
                prev = diff;
                closest = resultsArray[i];
            }
        }

        if(closest !== null)
        {
          _this.pick('#freqselector-item-'+closest.id);
      }
      };
    })(this)).trigger('overscroll:dragend');
  };

  Freqselector.prototype.initializeItemClick = function() {
    var _this = this;
    this.$content.off('mouseup').on('mouseup', '.freqselector-item-not-dummy', function(_ev) {
      if(!_this.$background.data('overscroll').dragging) {
        var clickedItem = this;

        // That's one lousy hack. If _this.pick is being called right away,
        // it looks like the mouseup event still intervents and makes the freqselector
        // jump back to its old value.
        setTimeout(function() {
          _this.pick('#' + jQuery(clickedItem).find('.freqselector-item-snap').attr('id'));
        }, 10);
        _ev.stopPropagation();
        return false;
      }
    });
  };

  Freqselector.prototype.pick = function (item) {
    if(typeof item !== "undefined") {
      this.$background.scrollTo(item, 500, { offset: (0 - this.arrowLeft - this.arrowCenterOffset + this.$element.offset().left), axis: 'x' });
      var e = $.Event('picked.freqselector', { 'item': item });
      this.$element.trigger(e);
      this.isSelected = item;
    }
  };

  Freqselector.prototype.resizeFreqselector = function () {
  var newWidth = 0;
  var documentWidth = Math.round(this.$body.width() / 2);

  this.$element.find('.freqselector-item-dummy').width(documentWidth);

  this.$element.find('.freqselector-item').each(function() {
    newWidth += $(this).width() + 4;
  });

  this.$content.width(newWidth);
  this.arrowLeft = Math.abs(this.$arrow.offset().left);
  };

  function Plugin(option, _relatedTarget) {
    return this.each(function () {
      var $this   = $(this);
      var data    = $this.data('freqselector');
      var options = $.extend({}, Freqselector.DEFAULTS, $this.data(), typeof option === 'object' && option);

      if (!data) {
        $this.data('freqselector', (data = new Freqselector(this, options)));
        if(options.show) {
          data.showFreqselector();
        }
      }
      if (typeof option === 'string') { data[option](_relatedTarget); }
    });
  }

  var old = $.fn.freqselector;

  $.fn.freqselector             = Plugin;
  $.fn.freqselector.Constructor = Freqselector;


  $.fn.freqselector.noConflict = function () {
    $.fn.freqselector = old;
    return this;
  };


  $(document).on('click.freqselector.data-api', '[data-toggle="freqselector"]', function (e) {
    var $this   = $(this);
    var href    = $this.attr('href');
    var $target = $($this.attr('data-target') || (href && href.replace(/.*(?=#[^\s]+$)/, ''))); // strip for ie7
    var option  = $target.data('freqselector') ? 'toggle' : $.extend({ remote: !/#/.test(href) && href }, $target.data(), $this.data());
    if ($this.is('a')) { e.preventDefault(); }

    $target.one('show.freqselector', function (showEvent) {
      if (showEvent.isDefaultPrevented()) { return; }
      $target.one('hidden.freqselector', function () {
        // if($this.is(':visible')) { $this.trigger('focus'); }
      });
    });
    Plugin.call($target, option, this);
  });

})(jQuery);

/*!
 * Retina.js v1.3.0
 *
 * Copyright 2014 Imulus, LLC
 * Released under the MIT license
 *
 * Retina.js is an open source script that makes it easy to serve
 * high-resolution images to devices with retina displays.
 */

(function() {
    var root = (typeof exports === 'undefined' ? window : exports);
    var config = {
        // An option to choose a suffix for 2x images
        retinaImageSuffix : '@2x',

        // Ensure Content-Type is an image before trying to load @2x image
        // https://github.com/imulus/retinajs/pull/45)
        check_mime_type: true,

        // Resize high-resolution images to original image's pixel dimensions
        // https://github.com/imulus/retinajs/issues/8
        force_original_dimensions: true
    };

    function Retina() {}

    root.Retina = Retina;

    Retina.configure = function(options) {
        if (options === null) {
            options = {};
        }

        for (var prop in options) {
            if (options.hasOwnProperty(prop)) {
                config[prop] = options[prop];
            }
        }
    };

    Retina.init = function(context) {
        if (context === null) {
            context = root;
        }

        var existing_onload = context.onload || function(){};

        context.onload = function() {
            var images = document.getElementsByTagName('img'), retinaImages = [], i, image;
            for (i = 0; i < images.length; i += 1) {
                image = images[i];
                if (!!!image.getAttributeNode('data-no-retina')) {
                    retinaImages.push(new RetinaImage(image));
                }
            }
            existing_onload();
        };
    };

    Retina.isRetina = function(){
        var mediaQuery = '(-webkit-min-device-pixel-ratio: 1.5), (min--moz-device-pixel-ratio: 1.5), (-o-min-device-pixel-ratio: 3/2), (min-resolution: 1.5dppx)';

        if (root.devicePixelRatio > 1) {
            return true;
        }

        if (root.matchMedia && root.matchMedia(mediaQuery).matches) {
            return true;
        }

        return false;
    };


    var regexMatch = /\.\w+$/;
    function suffixReplace (match) {
        return config.retinaImageSuffix + match;
    }

    function RetinaImagePath(path, at_2x_path) {
        this.path = path || '';
        if (typeof at_2x_path !== 'undefined' && at_2x_path !== null) {
            this.at_2x_path = at_2x_path;
            this.perform_check = false;
        } else {
            if (undefined !== document.createElement) {
                var locationObject = document.createElement('a');
                locationObject.href = this.path;
                locationObject.pathname = locationObject.pathname.replace(regexMatch, suffixReplace);
                this.at_2x_path = locationObject.href;
            } else {
                var parts = this.path.split('?');
                parts[0] = parts[0].replace(regexMatch, suffixReplace);
                this.at_2x_path = parts.join('?');
            }
            this.perform_check = true;
        }
    }

    root.RetinaImagePath = RetinaImagePath;

    RetinaImagePath.confirmed_paths = [];

    RetinaImagePath.prototype.is_external = function() {
        return !!(this.path.match(/^https?\:/i) && !this.path.match('//' + document.domain) );
    };

    RetinaImagePath.prototype.check_2x_variant = function(callback) {
        var http, that = this;
        if (this.is_external()) {
            return callback(false);
        } else if (!this.perform_check && typeof this.at_2x_path !== 'undefined' && this.at_2x_path !== null) {
            return callback(true);
        } else if (this.at_2x_path in RetinaImagePath.confirmed_paths) {
            return callback(true);
        } else {
            http = new XMLHttpRequest();
            http.open('HEAD', this.at_2x_path);
            http.onreadystatechange = function() {
                if (http.readyState !== 4) {
                    return callback(false);
                }

                if (http.status >= 200 && http.status <= 399) {
                    if (config.check_mime_type) {
                        var type = http.getResponseHeader('Content-Type');
                        if (type === null || !type.match(/^image/i)) {
                            return callback(false);
                        }
                    }

                    RetinaImagePath.confirmed_paths.push(that.at_2x_path);
                    return callback(true);
                } else {
                    return callback(false);
                }
            };
            http.send();
        }
    };


    function RetinaImage(el) {
        this.el = el;
        this.path = new RetinaImagePath(this.el.getAttribute('src'), this.el.getAttribute('data-at2x'));
        var that = this;
        this.path.check_2x_variant(function(hasVariant) {
            if (hasVariant) {
                that.swap();
            }
        });
    }

    root.RetinaImage = RetinaImage;

    RetinaImage.prototype.swap = function(path) {
        if (typeof path === 'undefined') {
            path = this.path.at_2x_path;
        }

        var that = this;
        function load() {
            if (! that.el.complete) {
                setTimeout(load, 5);
            } else {
                if (config.force_original_dimensions) {
                    that.el.setAttribute('width', that.el.offsetWidth);
                    that.el.setAttribute('height', that.el.offsetHeight);
                }

                that.el.setAttribute('src', path);
            }
        }
        load();
    };


    if (Retina.isRetina()) {
        Retina.init(root);
    }
})();
